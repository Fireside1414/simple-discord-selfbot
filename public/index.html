<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Multi-Account SelfBot Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --sidebar: #020617; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #334155; flex-shrink: 0; z-index: 10; transition: transform 0.3s ease; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 1.2rem; text-align: center; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .account-list { flex: 1; overflow-y: auto; padding: 10px; }
        .account-item { display: flex; align-items: center; padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; transition: 0.2s; border: 1px solid transparent; background: rgba(255,255,255,0.03); }
        .account-item:hover { background: #1e293b; }
        .account-item.active { background: #1e293b; border-color: var(--accent); }
        .acc-avatar { width: 36px; height: 36px; border-radius: 50%; background: #334155; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; flex-shrink: 0; }
        .acc-info { display: flex; flex-direction: column; overflow: hidden; }
        .acc-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .acc-status { font-size: 0.75rem; color: #94a3b8; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background: #22c55e; } .dot-red { background: #ef4444; }
        .sidebar-btn { margin: 5px 10px; padding: 10px; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; text-align: center; display: block; width: calc(100% - 20px); }
        .btn-add { background: var(--accent); } .btn-settings { background: #334155; } .btn-logout { background: transparent; border: 1px solid #ef4444; color: #ef4444; margin-top: auto; }
        .main { flex: 1; padding: 20px; overflow-y: auto; position: relative; width: 100%; }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 50px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #334155; flex-wrap: wrap; gap: 10px; }
        .current-bot-name { font-size: 1.3rem; font-weight: bold; margin: 0; word-break: break-word; }
        .power-btn { padding: 8px 16px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .power-on { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; }
        .power-off { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .nav-btn { background: var(--card); border: 1px solid #334155; color: #94a3b8; padding: 10px 15px; cursor: pointer; border-radius: 8px; flex: none; font-weight: bold; font-size: 0.9rem; white-space: nowrap; }
        .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .section { display: none; } .section.active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #334155; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #cbd5e1; font-size: 0.85rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        input:focus, select:focus, textarea:focus { font-size: 16px; } 
        .row { display: flex; gap: 15px; flex-wrap: wrap; } .col { flex: 1; min-width: 100%; } 
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 0.95rem; }
        .btn-primary { background: var(--accent); width: 100%; margin-top: 10px; }
        .btn-danger { background: #ef4444; }
        .switch-row { display: flex; align-items: center; justify-content: space-between; background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--accent); }
        .mobile-menu-btn { display: none; background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .image-input-group { display: flex; align-items: flex-start; gap: 10px; }
        .img-preview { width: 80px; height: 80px; background: #000; border: 1px solid #334155; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; color: #64748b; font-size: 0.8rem; text-align: center; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .select-wrapper { position: relative; }
        .select-wrapper::after { content: '‚ñº'; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #fff; font-size: 0.6rem; pointer-events: none; }
        @media (min-width: 768px) { .col { min-width: 200px; } .mobile-menu-btn { display: none; } }
        @media (max-width: 768px) { body { flex-direction: column; height: 100%; overflow: hidden; } .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 80%; max-width: 300px; transform: translateX(-100%); z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); } .sidebar.open { transform: translateX(0); } .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; } .sidebar-overlay.active { display: block; } .main { width: 100%; padding: 10px; padding-top: 15px; } .container { padding-bottom: 80px; } .top-bar { flex-direction: row; align-items: center; padding: 10px; gap: 5px; } .top-bar div:first-child { flex: 1; overflow: hidden; } .current-bot-name { font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .mobile-menu-btn { display: block; margin-right: 10px; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #fff; }
        .voice-timer { font-size: 1.2rem; font-weight: bold; color: #22c55e; background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 8px; text-align: center; margin-top: 15px; border: 1px solid rgba(34, 197, 94, 0.3); }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        .grid-item { cursor: pointer; border: 2px solid transparent; border-radius: 5px; overflow: hidden; position: relative; background: #000; aspect-ratio: 1; }
        .grid-item:hover { border-color: var(--accent); }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .grid-item p { position: absolute; bottom:0; left:0; width:100%; margin: 0; font-size: 0.6rem; text-align: center; padding: 2px; background: rgba(0,0,0,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-btn-img { position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 3px; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
    </style>
</head>
<body>

<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar" class="sidebar">
    <div class="sidebar-header"><span>ü§ñ Manager</span><button onclick="toggleSidebar()" style="background:none; border:none; color:#94a3b8; font-size:1.5rem; cursor:pointer;" class="mobile-only">√ó</button></div>
    <button class="sidebar-btn btn-add" onclick="createAccount()">+ Th√™m T√†i Kho·∫£n</button>
    <button class="sidebar-btn btn-settings" onclick="openSystemSettings()">‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</button>
    <div id="accountList" class="account-list"></div>
    <button class="sidebar-btn btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
</div>

<div class="main">
    <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <h3 style="margin:0" id="mobileHeaderTitle">Ch·ªçn Bot ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
    </div>

    <div class="container" id="mainContainer" style="display:none;">
        <div class="top-bar">
            <div><h2 id="displayBotName" class="current-bot-name">Bot Name</h2><small id="displayBotId" style="color:#64748b; font-size: 0.75rem;">ID: ...</small></div>
            <div style="display:flex; gap:8px;"><button id="powerBtn" class="power-btn" onclick="togglePower()">...</button><button class="btn btn-danger" onclick="deleteAccount()" style="padding: 8px 12px;">üóëÔ∏è</button></div>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showTab('rpc')">RPC</button>
            <button class="nav-btn" onclick="showTab('voice')">Voice</button>
            <button class="nav-btn" onclick="showTab('general')">General</button>
        </div>

        <div id="rpc" class="section active">
            <div class="card">
                <div class="switch-row"><span>B·∫≠t RPC</span><input type="checkbox" id="enabled"></div>
                <div class="form-group"><label style="color:#f59e0b">Application ID (N·∫øu d√πng Asset Key)</label><input type="text" id="applicationId" placeholder="L·∫•y t·ª´ Dev Portal (Optional)" oninput="updateImageLabels()"></div>
                <div class="row"><div class="col"><label>Lo·∫°i</label><div class="select-wrapper"><select id="type"><option value="PLAYING">Playing</option><option value="STREAMING">Streaming</option><option value="LISTENING">Listening</option><option value="WATCHING">Watching</option><option value="COMPETING">Competing</option></select></div></div><div class="col"><label>T√™n</label><input type="text" id="name" placeholder="T√™n ho·∫°t ƒë·ªông"></div></div>
                <div class="row" style="margin-top:10px"><div class="col"><label>Chi ti·∫øt</label><input type="text" id="details"></div><div class="col"><label>Tr·∫°ng th√°i</label><input type="text" id="state"></div></div>
                <div class="row" style="margin-top:10px">
                    <div class="col"><label id="lblLargeImage">Large Image (URL/Key)</label><div class="image-input-group"><div style="flex:1"><div style="display:flex; gap:5px"><input type="text" id="largeImage" oninput="updatePreview('largeImage')" placeholder="Link ·∫£nh ho·∫∑c Key"><button class="btn" style="padding:12px; background:#475569" onclick="openImageSelector('largeImage')">üìÇ</button></div><input type="text" id="largeText" placeholder="Large Text" style="margin-top:5px"></div><div class="img-preview"><img id="preview-largeImage"></div></div></div>
                    <div class="col"><label id="lblSmallImage">Small Image (URL/Key)</label><div class="image-input-group"><div style="flex:1"><div style="display:flex; gap:5px"><input type="text" id="smallImage" oninput="updatePreview('smallImage')" placeholder="Link ·∫£nh ho·∫∑c Key"><button class="btn" style="padding:12px; background:#475569" onclick="openImageSelector('smallImage')">üìÇ</button></div><input type="text" id="smallText" placeholder="Small Text" style="margin-top:5px"></div><div class="img-preview"><img id="preview-smallImage"></div></div></div>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">L∆∞u RPC</button>
            </div>
            
            <div class="card">
                <h4 style="margin-top:0">üîò N√∫t b·∫•m</h4>
                <div class="row"><div class="col"><label>N√∫t 1 T√™n</label><input type="text" id="button1Label"></div><div class="col"><label>N√∫t 1 Link (B·∫Øt bu·ªôc)</label><input type="text" id="button1URL"></div></div>
                <div class="row" style="margin-top:10px"><div class="col"><label>N√∫t 2 T√™n</label><input type="text" id="button2Label"></div><div class="col"><label>N√∫t 2 Link (B·∫Øt bu·ªôc)</label><input type="text" id="button2URL"></div></div>
            </div>
        </div>

        <div id="voice" class="section">
            <div class="card">
                <div class="switch-row"><span>Auto Join Voice</span><input type="checkbox" id="voiceEnabled"></div>
                <div class="row"><div class="col"><label>Guild ID</label><input type="text" id="voiceGuildId"></div><div class="col"><label>Channel ID</label><input type="text" id="voiceChannelId"></div></div>
                <div class="switch-row" style="margin-top:10px"><span>Camera ·∫£o</span><input type="checkbox" id="voiceVideo"></div>
                <div id="voiceTimerContainer" style="display:none;"><div class="voice-timer">‚è±Ô∏è Treo: <span id="voiceTimer">00:00:00</span></div></div>
                <button class="btn btn-primary" onclick="saveConfig()">L∆∞u Voice</button>
            </div>
        </div>

        <div id="general" class="section">
            <div class="card">
                <h3 style="margin-top:0">C·∫•u h√¨nh chung</h3>
                <div class="form-group"><label>T√™n hi·ªÉn th·ªã</label><input type="text" id="botNameConfig"></div>
                <div class="form-group"><label style="color:#f59e0b">Token</label><input type="password" id="token"></div>
                <div class="form-group"><label>Tr·∫°ng th√°i thi·∫øt b·ªã</label><div class="select-wrapper"><select id="deviceType"><option value="desktop">Desktop</option><option value="mobile">Mobile</option><option value="web">Web</option></select></div></div>
                <div class="switch-row"><span>Auto Chat</span><input type="checkbox" id="autoChatEnabled"></div>
                <div class="form-group"><label>K√™nh Chat ID</label><input type="text" id="autoChatChannelId"></div>
                <button class="btn btn-primary" onclick="saveConfig()">L∆∞u C·∫•u H√¨nh</button>
            </div>
        </div>
    </div>
    <div id="welcomeMsg" style="text-align:center; margin-top:50px; color:#64748b; padding: 20px;"><h2>Ch√†o m·ª´ng!</h2><p>B·∫•m n√∫t ‚ò∞ b√™n tr√™n ƒë·ªÉ ch·ªçn Bot.</p></div>
</div>

<div id="systemModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('systemModal').style.display='none'">&times;</span>
        <h3 style="margin-top:0">‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h3>
        <div class="form-group"><label>Webhook URL</label><input type="text" id="sysWebhook"></div>
        <div style="display:flex; gap:10px"><button class="btn btn-primary" onclick="saveSystemSettings(false)">L∆∞u</button><button class="btn" style="background:#334155; margin-top:10px" onclick="saveSystemSettings(true)">L∆∞u & Test</button></div>
    </div>
</div>

<div id="imageModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
        <h3 style="margin-top:0">Ch·ªçn ·∫£nh</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #334155; padding-bottom:15px;">
            <input type="text" id="newImageUrl" placeholder="Link ·∫£nh online (https://...)">
            <button class="btn" style="background:var(--accent); width: 80px; padding: 10px;" onclick="saveNewUrl()">‚ûï</button>
        </div>
        <div style="font-size:0.8rem; color:#94a3b8">ƒê√£ l∆∞u</div><div id="saved-grid" class="image-grid"></div>
        <div style="font-size:0.8rem; color:#94a3b8; margin-top:15px">Trong m√°y</div><div id="local-grid" class="image-grid"></div>
    </div>
</div>

<script>
    let currentAccountId = null;
    let currentBotRunning = false;
    let voiceJoinTime = null;
    let timerInterval = null;
    let currentTargetInput = null;
    let pollInterval = null;

    const inputs = ['token','name','type','details','state','largeImage','largeText','smallImage','smallText','button1Label','button1URL','button2Label','button2URL','voiceGuildId','voiceChannelId','autoChatChannelId', 'deviceType', 'applicationId'];
    const checks = ['enabled','voiceEnabled','voiceVideo','autoChatEnabled'];

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('active'); }

    async function loadAccounts() {
        const res = await fetch('/api/accounts');
        if(res.status === 401) return window.location.href = '/login.html';
        const list = await res.json();
        document.getElementById('accountList').innerHTML = list.map(bot => `<div class="account-item ${bot.id === currentAccountId ? 'active' : ''}" onclick="selectAccount('${bot.id}')"><div class="acc-avatar">${bot.name.substring(0,2).toUpperCase()}</div><div class="acc-info"><div class="acc-name">${bot.name}</div><div class="acc-status"><span class="status-dot ${bot.isRunning ? 'dot-green' : 'dot-red'}"></span>${bot.isRunning ? 'Online' : 'Offline'}</div></div></div>`).join('');
        
        if(currentAccountId) {
            const currentBot = list.find(b => b.id === currentAccountId);
            if(currentBot && currentBot.isRunning !== currentBotRunning) {
                currentBotRunning = currentBot.isRunning;
                updatePowerBtn();
                if(currentBotRunning) {
                    const detailRes = await fetch(`/api/accounts/${currentAccountId}`);
                    const detailData = await detailRes.json();
                    voiceJoinTime = detailData.voiceJoinedAt;
                    startVoiceTimer();
                }
            }
        }
    }

    async function createAccount() { await fetch('/api/accounts/create', { method: 'POST' }); loadAccounts(); }

    async function selectAccount(id) {
        currentAccountId = id;
        document.getElementById('welcomeMsg').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
        
        loadAccounts();
        const res = await fetch(`/api/accounts/${id}`);
        const data = await res.json();
        
        document.getElementById('displayBotName').innerText = data.name || 'Unnamed';
        document.getElementById('mobileHeaderTitle').innerText = data.name || 'Manager';
        document.getElementById('displayBotId').innerText = 'ID: ' + id;
        document.getElementById('botNameConfig').value = data.name || '';
        
        inputs.forEach(k => { if(document.getElementById(k)) { if(k === 'deviceType' && !data[k]) document.getElementById(k).value = 'desktop'; else document.getElementById(k).value = data[k] || ''; } });
        checks.forEach(k => { if(document.getElementById(k)) document.getElementById(k).checked = !!data[k]; });

        currentBotRunning = data.isRunning;
        voiceJoinTime = data.voiceJoinedAt;
        updatePowerBtn();
        startVoiceTimer();
        updatePreview('largeImage'); updatePreview('smallImage');
        updateImageLabels();
        
        if(pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(loadAccounts, 2000);
    }

    function updateImageLabels() {
        const appId = document.getElementById('applicationId').value;
        const lblLarge = document.getElementById('lblLargeImage');
        const lblSmall = document.getElementById('lblSmallImage');
        if (appId && appId.trim() !== '') {
            lblLarge.innerText = "Large Asset Key (T√™n ·∫£nh)";
            lblSmall.innerText = "Small Asset Key (T√™n ·∫£nh)";
        } else {
            lblLarge.innerText = "Large Image (Link URL)";
            lblSmall.innerText = "Small Image (Link URL)";
        }
    }

    function updatePreview(type) {
        const val = document.getElementById(type).value;
        const previewDiv = document.querySelector(`#${type}`).closest('.image-input-group').querySelector('.img-preview');
        const img = document.getElementById('preview-' + type);
        
        const appId = document.getElementById('applicationId').value;
        if(appId && appId.trim() !== '') {
            img.style.display = 'none'; 
            previewDiv.innerText = 'Key: ' + val;
        } else {
            if(val) { img.src = val; img.onload = () => { img.style.display = 'block'; previewDiv.innerText = ''; }; img.onerror = () => { img.style.display = 'none'; previewDiv.innerText = '‚ùå Link Die'; } } 
            else { img.style.display = 'none'; previewDiv.innerText = 'Preview'; }
        }
    }

    async function saveConfig() {
        if(!currentAccountId) return;
        const data = { name: document.getElementById('botNameConfig').value };
        inputs.forEach(k => data[k] = document.getElementById(k).value);
        checks.forEach(k => data[k] = document.getElementById(k).checked);
        await fetch(`/api/accounts/${currentAccountId}/config`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        alert('ƒê√£ l∆∞u!');
        selectAccount(currentAccountId);
    }

    async function togglePower() {
        if(!currentAccountId) return;
        const action = currentBotRunning ? 'stop' : 'start';
        document.getElementById('powerBtn').innerText = '...';
        
        const tempConfig = {};
        if (action === 'start') {
            inputs.forEach(k => tempConfig[k] = document.getElementById(k).value);
            checks.forEach(k => tempConfig[k] = document.getElementById(k).checked);
        }

        try {
            const res = await fetch(`/api/accounts/${currentAccountId}/power`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action, tempConfig }) });
            const data = await res.json();
            if (action === 'start' && !data.isRunning) alert(data.message || "L·ªói. Ki·ªÉm tra Token!");
            currentBotRunning = data.isRunning;
            updatePowerBtn();
            loadAccounts();
        } catch(e) { alert("M·∫•t k·∫øt n·ªëi!"); }
    }

    function updatePowerBtn() { const btn = document.getElementById('powerBtn'); if(currentBotRunning) { btn.className = 'power-btn power-on'; btn.innerText = 'ONLINE'; } else { btn.className = 'power-btn power-off'; btn.innerText = 'OFFLINE'; } }

    function startVoiceTimer() {
        if (timerInterval) clearInterval(timerInterval);
        const container = document.getElementById('voiceTimerContainer');
        const timerEl = document.getElementById('voiceTimer');
        if (!voiceJoinTime || !currentBotRunning) { container.style.display = 'none'; return; }
        container.style.display = 'block';
        timerInterval = setInterval(() => {
            const diff = Date.now() - voiceJoinTime;
            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            let str = '';
            if (days > 0) str = `${days}d ${hours}h ${minutes}m`;
            else if (hours > 0) str = `${hours}h ${minutes}m ${seconds}s`;
            else str = `${minutes}m ${seconds}s`;
            timerEl.innerText = str;
        }, 1000);
    }

    async function openSystemSettings() {
        const res = await fetch('/api/system');
        const data = await res.json();
        document.getElementById('sysWebhook').value = data.webhookUrl || '';
        document.getElementById('systemModal').style.display = 'flex';
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
    }
    async function saveSystemSettings(test) {
        const url = document.getElementById('sysWebhook').value;
        await fetch('/api/system', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ webhookUrl: url, test: test }) });
        alert(test ? 'ƒê√£ l∆∞u v√† g·ª≠i tin test!' : 'ƒê√£ l∆∞u c√†i ƒë·∫∑t!');
        document.getElementById('systemModal').style.display = 'none';
    }

    async function openImageSelector(target) {
        currentTargetInput = target;
        document.getElementById('imageModal').style.display = 'flex';
        const res = await fetch('/api/images');
        const data = await res.json();
        const savedHtml = data.savedUrls.length ? data.savedUrls.map(url => `<div class="grid-item"><button class="delete-btn-img" onclick="deleteUrl('${url}'); event.stopPropagation();">√ó</button><div onclick="selectImage('${url}')"><img src="${url}"><p>URL</p></div></div>`).join('') : '<p style="color:#64748b; font-size:0.8rem">Tr·ªëng.</p>';
        document.getElementById('saved-grid').innerHTML = savedHtml;
        const localHtml = data.local.length ? data.local.map(img => `<div class="grid-item" onclick="selectImage('${window.location.origin}/images/${img}')"><img src="/images/${img}"><p>${img}</p></div>`).join('') : '<p style="color:#64748b; font-size:0.8rem">Tr·ªëng.</p>';
        document.getElementById('local-grid').innerHTML = localHtml;
    }

    async function saveNewUrl() {
        const url = document.getElementById('newImageUrl').value;
        if(!url) return alert("Ch∆∞a nh·∫≠p link!");
        await fetch('/api/images/url', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url }) });
        document.getElementById('newImageUrl').value = '';
        openImageSelector(currentTargetInput);
    }
    async function deleteUrl(url) {
        if(!confirm("X√≥a?")) return;
        await fetch('/api/images/url', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url }) });
        openImageSelector(currentTargetInput);
    }
    function selectImage(url) { document.getElementById(currentTargetInput).value = url; updatePreview(currentTargetInput); document.getElementById('imageModal').style.display='none'; }

    async function deleteAccount() { if(confirm("X√≥a?")) { await fetch(`/api/accounts/${currentAccountId}`, { method: 'DELETE' }); location.reload(); } }
    async function logout() { await fetch('/api/logout', { method: 'POST' }); location.href = '/login.html'; }
    function showTab(id) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); event.currentTarget.classList.add('active'); }
    
    document.getElementById('largeImage').oninput = () => updatePreview('largeImage');
    document.getElementById('smallImage').oninput = () => updatePreview('smallImage');

    loadAccounts();
    
    // X√≥a Log R√°c (N√∫t ·∫©n)
    async function clearTrashLogs() { await fetch('/api/afklogs', { method: 'DELETE' }); location.reload(); }
</script>

</body>
</html>
